# PyQuantLib: Python bindings for QuantLib
# Copyright (c) 2025 Yassine Idyiahia
#
# QuantLib is Copyright (c) 2000-2025 The QuantLib Authors
# QuantLib is free software under a modified BSD license.
# See http://quantlib.org/ for more information.
#
# Source: https://github.com/quantales/pyquantlib
# Licensed under the BSD 3-Clause License. See LICENSE file for details.

name: Windows build

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

# Manual-only for now - building QuantLib from source takes ~15-20 minutes (cached after first run)

env:
  QUANTLIB_VERSION: "1.40"

jobs:
  build:
    if: github.event_name == 'workflow_dispatch'  # Only run manually for now
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.11"]  # Expand when stable

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Cache Boost
        id: cache-boost
        uses: actions/cache@v4
        with:
          path: C:/boost
          key: boost-1.86-windows-v1

      - name: Install Boost via vcpkg
        if: steps.cache-boost.outputs.cache-hit != 'true'
        run: |
          vcpkg install boost:x64-windows
          mkdir C:\boost
          xcopy /E /I /Y "$env:VCPKG_INSTALLATION_ROOT\installed\x64-windows\include\boost" "C:\boost\include\boost"
          xcopy /E /I /Y "$env:VCPKG_INSTALLATION_ROOT\installed\x64-windows\lib" "C:\boost\lib"

      - name: Cache QuantLib
        id: cache-quantlib
        uses: actions/cache@v4
        with:
          path: C:/quantlib-install
          key: quantlib-${{ env.QUANTLIB_VERSION }}-std-windows-v1
          restore-keys: |
            quantlib-${{ env.QUANTLIB_VERSION }}-std-windows-

      - name: Build QuantLib from source
        if: steps.cache-quantlib.outputs.cache-hit != 'true'
        run: |
          Invoke-WebRequest -Uri "https://github.com/lballabio/QuantLib/releases/download/v$env:QUANTLIB_VERSION/QuantLib-$env:QUANTLIB_VERSION.tar.gz" -OutFile "QuantLib.tar.gz"
          tar xzf QuantLib.tar.gz
          cd "QuantLib-$env:QUANTLIB_VERSION"
          mkdir build
          cd build
          cmake .. -G "Visual Studio 17 2022" -A x64 `
            -DCMAKE_BUILD_TYPE=Release `
            -DCMAKE_INSTALL_PREFIX=C:/quantlib-install `
            -DQL_USE_STD_SHARED_PTR=ON `
            -DQL_USE_STD_OPTIONAL=ON `
            -DQL_USE_STD_ANY=ON `
            -DQL_BUILD_EXAMPLES=OFF `
            -DQL_BUILD_TEST_SUITE=OFF `
            -DQL_BUILD_BENCHMARK=OFF `
            -DBoost_ROOT=C:/boost `
            -DBoost_INCLUDE_DIR=C:/boost/include
          cmake --build . --config Release --parallel
          cmake --install . --config Release

      - name: Verify QuantLib configuration
        run: |
          Write-Host "Checking QuantLib config.hpp for std:: flags..."
          Select-String -Path "C:\quantlib-install\include\ql\config.hpp" -Pattern "QL_USE_STD_(SHARED_PTR|OPTIONAL|ANY)"

      - name: Install Python build dependencies
        run: |
          python -m pip install --upgrade pip

      - name: Build package with dev dependencies
        run: |
          pip install -e .[dev] -v
        env:
          QuantLib_ROOT: C:/quantlib-install
          Boost_ROOT: C:/boost
          Boost_INCLUDE_DIR: C:/boost/include

      - name: Run tests
        run: |
          pytest -v
